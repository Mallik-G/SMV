<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>smv.smvpydataset &#8212; smv  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for smv.smvpydataset</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># This file is licensed under the Apache License, Version 2.0</span>
<span class="c1"># (the &quot;License&quot;); you may not use this file except in compliance with</span>
<span class="c1"># the License.  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;SMV DataSet Framework interface</span>

<span class="sd">This module defines the abstract classes which formed the SmvDataSet Framework for clients&#39; projects</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pyspark</span> <span class="k">import</span> <span class="n">SparkContext</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">HiveContext</span><span class="p">,</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.column</span> <span class="k">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="k">import</span> <span class="n">col</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">smv_copy_array</span>

<span class="kn">import</span> <span class="nn">abc</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">dqm</span> <span class="k">import</span> <span class="n">SmvDQM</span>
<span class="kn">from</span> <span class="nn">error</span> <span class="k">import</span> <span class="n">SmvRuntimeError</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">reload</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="k">import</span> <span class="n">StringIO</span>

<span class="k">def</span> <span class="nf">_disassemble</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disassembles a module and returns bytecode as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">obj</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">dis</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
        <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">_smvhash</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Python&#39;s hash function will return different numbers from run to</span>
<span class="sd">    from, starting from 3.  Provide a deterministic hash function for</span>
<span class="sd">    use to calculate datasetHash.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_stripComments</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?m)^ *(#.*\n?|[ \t]*\n)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

<div class="viewcode-block" id="SmvOutput"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvOutput">[docs]</a><span class="k">class</span> <span class="nc">SmvOutput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin which marks an SmvModule as one of the output of its stage</span>

<span class="sd">        SmvOutputs are distinct from other SmvDataSets in that</span>
<span class="sd">            * SmvModuleLinks can *only* link to SmvOutputs</span>
<span class="sd">            * The -s and --run-app options of smv-pyrun only run SmvOutputs and their dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">IsSmvOutput</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="SmvOutput.tableName"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvOutput.tableName">[docs]</a>    <span class="k">def</span> <span class="nf">tableName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The user-specified table name used when exporting data to Hive (optional)</span>

<span class="sd">            Returns:</span>
<span class="sd">                (string)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="SmvPyDataSet"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet">[docs]</a><span class="k">class</span> <span class="nc">SmvPyDataSet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for all SmvDataSets</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Python&#39;s issubclass() check does not work well with dynamically</span>
    <span class="c1"># loaded modules.  In addition, there are some issues with the</span>
    <span class="c1"># check, when the `abc` module is used as a metaclass, that we</span>
    <span class="c1"># don&#39;t yet quite understand.  So for a workaround we add the</span>
    <span class="c1"># typcheck in the Smv hierarchies themselves.</span>
    <span class="n">IsSmvPyDataSet</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smvApp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span> <span class="o">=</span> <span class="n">smvApp</span>

<div class="viewcode-block" id="SmvPyDataSet.description"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<div class="viewcode-block" id="SmvPyDataSet.requiresDS"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.requiresDS">[docs]</a>    <span class="k">def</span> <span class="nf">requiresDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User-specified list of dependencies</span>

<span class="sd">            Override this method to specify the SmvDataSets needed as inputs.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (list(SmvDataSet)): a list of dependencies</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="SmvPyDataSet.dqm"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.dqm">[docs]</a>    <span class="k">def</span> <span class="nf">dqm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DQM policy</span>

<span class="sd">            Override this method to define your own DQM policy (optional).</span>
<span class="sd">            Default is an empty policy.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (SmvDQM): a DQM policy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SmvDQM</span><span class="p">()</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<div class="viewcode-block" id="SmvPyDataSet.doRun"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.doRun">[docs]</a>    <span class="k">def</span> <span class="nf">doRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Comput this dataset, and return the dataframe&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="SmvPyDataSet.version"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.version">[docs]</a>    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Version number</span>

<span class="sd">            Each SmvDataSet is versioned with a numeric string, so it and its result</span>
<span class="sd">            can be tracked together.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (str): version number of this SmvDataSet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span></div>

<div class="viewcode-block" id="SmvPyDataSet.isOutput"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.isOutput">[docs]</a>    <span class="k">def</span> <span class="nf">isOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SmvOutput</span><span class="p">)</span></div>

<div class="viewcode-block" id="SmvPyDataSet.datasetHash"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.datasetHash">[docs]</a>    <span class="k">def</span> <span class="nf">datasetHash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="n">src_no_comm</span> <span class="o">=</span> <span class="n">_stripComments</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="c1"># DO NOT use the compiled byte code for the hash computation as</span>
                <span class="c1"># it doesn&#39;t change when constant values are changed.  For example,</span>
                <span class="c1"># &quot;a = 5&quot; and &quot;a = 6&quot; compile to same byte code.</span>
                <span class="c1"># co_code = compile(src, inspect.getsourcefile(cls), &#39;exec&#39;).co_code</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">_smvhash</span><span class="p">(</span><span class="n">src_no_comm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> <span class="c1"># `inspect` will raise error for classes defined in the REPL</span>
                <span class="c1"># Instead of handle the case that module defined in REPL, just raise Exception here</span>
                <span class="c1"># res = _smvhash(_disassemble(cls))</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">(</span><span class="si">{1!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;SmvDataSet &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">urn</span><span class="p">()</span> <span class="o">+</span><span class="s2">&quot; defined in shell can&#39;t be persisted&quot;</span><span class="p">)</span>

            <span class="c1"># include datasetHash of parent classes</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">IsSmvPyDataSet</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">!=</span> <span class="bp">cls</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">fqn</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;smv.&quot;</span><span class="p">):</span>
                        <span class="n">res</span> <span class="o">+=</span> <span class="n">m</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="p">)</span><span class="o">.</span><span class="n">datasetHash</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

            <span class="c1"># if module inherits from SmvRunConfig, then add hash of all config values to module hash</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_smvGetRunConfigHash&quot;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smvGetRunConfigHash</span><span class="p">()</span>

            <span class="c1"># ensure python&#39;s numeric type can fit in a java.lang.Integer</span>
            <span class="k">return</span> <span class="n">res</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SmvPyDataSet.fqn"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.fqn">[docs]</a>    <span class="k">def</span> <span class="nf">fqn</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the fully qualified name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SmvPyDataSet.urn"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.urn">[docs]</a>    <span class="k">def</span> <span class="nf">urn</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;mod:&quot;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fqn</span><span class="p">()</span></div>

<div class="viewcode-block" id="SmvPyDataSet.isEphemeral"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.isEphemeral">[docs]</a>    <span class="k">def</span> <span class="nf">isEphemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Should this SmvDataSet skip persisting its data?</span>

<span class="sd">            Returns:</span>
<span class="sd">                (bool): True if this SmvDataSet should not persist its data, false otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SmvPyDataSet.publishHiveSql"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.publishHiveSql">[docs]</a>    <span class="k">def</span> <span class="nf">publishHiveSql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An optional sql query to run to publish the results of this module when the</span>
<span class="sd">           --publish-hive command line is used.  The DataFrame result of running this</span>
<span class="sd">           module will be available to the query as the &quot;dftable&quot; table.</span>

<span class="sd">            Example:</span>
<span class="sd">                &gt;&gt;&gt; return &quot;insert overwrite table mytable select * from dftable&quot;</span>

<span class="sd">            Note:</span>
<span class="sd">                If this method is not specified, the default is to just create the table specified by tableName() with the results of the module.</span>

<span class="sd">           Returns:</span>
<span class="sd">               (string): the query to run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<div class="viewcode-block" id="SmvPyDataSet.dsType"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.dsType">[docs]</a>    <span class="k">def</span> <span class="nf">dsType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return SmvPyDataSet&#39;s type&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="SmvPyDataSet.dqmWithTypeSpecificPolicy"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.dqmWithTypeSpecificPolicy">[docs]</a>    <span class="k">def</span> <span class="nf">dqmWithTypeSpecificPolicy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dqm</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="SmvPyDataSet.dependencies"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Try/except block is a short-term solution (read: hack) to ensure that</span>
        <span class="c1"># the user gets a full stack trace when SmvPyDataSet user-defined methods</span>
        <span class="c1"># causes errors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">smv_copy_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">urn</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requiresDS</span><span class="p">()])</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">arr</span></div>

<div class="viewcode-block" id="SmvPyDataSet.getDataFrame"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.getDataFrame">[docs]</a>    <span class="k">def</span> <span class="nf">getDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="c1"># Try/except block is a short-term solution (read: hack) to ensure that</span>
        <span class="c1"># the user gets a full stack trace when SmvPyDataSet user-defined methods</span>
        <span class="c1"># causes errors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRun</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SmvRuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; produced &quot;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot; in place of a DataFrame&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">_jdf</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">jdf</span></div>

<div class="viewcode-block" id="SmvPyDataSet.Java"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyDataSet.Java">[docs]</a>    <span class="k">class</span> <span class="nc">Java</span><span class="p">:</span>
        <span class="n">implements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;org.tresamigos.smv.ISmvModule&#39;</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="SmvPyInput"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyInput">[docs]</a><span class="k">class</span> <span class="nc">SmvPyInput</span><span class="p">(</span><span class="n">SmvPyDataSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SmvDataSet representing external input</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SmvPyInput.isEphemeral"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyInput.isEphemeral">[docs]</a>    <span class="k">def</span> <span class="nf">isEphemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SmvPyInput.dsType"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyInput.dsType">[docs]</a>    <span class="k">def</span> <span class="nf">dsType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Input&quot;</span></div>

<div class="viewcode-block" id="SmvPyInput.requiresDS"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyInput.requiresDS">[docs]</a>    <span class="k">def</span> <span class="nf">requiresDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="SmvPyInput.run"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvPyInput.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Post-processing for input data</span>

<span class="sd">            Args:</span>
<span class="sd">                df (DataFrame): input data</span>

<span class="sd">            Returns:</span>
<span class="sd">                (DataFrame): processed data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span></div></div>

<div class="viewcode-block" id="WithParser"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser">[docs]</a><span class="k">class</span> <span class="nc">WithParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;shared parser funcs&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WithParser.dqmWithTypeSpecificPolicy"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.dqmWithTypeSpecificPolicy">[docs]</a>    <span class="k">def</span> <span class="nf">dqmWithTypeSpecificPolicy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;for parsers we should get the type specific dqm policy from the</span>
<span class="sd">           concrete scala proxy class that is the actual input (e.g. SmvCsvFile)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">userDqm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dqm</span><span class="p">()</span>
            <span class="n">scalaInputDS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRawScalaInputDS</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">scalaInputDS</span><span class="o">.</span><span class="n">dqmWithTypeSpecificPolicy</span><span class="p">(</span><span class="n">userDqm</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="WithParser.getRawScalaInputDS"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.getRawScalaInputDS">[docs]</a>    <span class="k">def</span> <span class="nf">getRawScalaInputDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;derived classes should provide the raw scala proxy input dataset (e.g. SmvCsvFile)</span>
<span class="sd">           that is created in their init.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="WithParser.forceParserCheck"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.forceParserCheck">[docs]</a>    <span class="k">def</span> <span class="nf">forceParserCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WithParser.failAtParsingError"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.failAtParsingError">[docs]</a>    <span class="k">def</span> <span class="nf">failAtParsingError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WithParser.defaultCsvWithHeader"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.defaultCsvWithHeader">[docs]</a>    <span class="k">def</span> <span class="nf">defaultCsvWithHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">defaultCsvWithHeader</span><span class="p">()</span></div>

<div class="viewcode-block" id="WithParser.defaultTsv"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.defaultTsv">[docs]</a>    <span class="k">def</span> <span class="nf">defaultTsv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">defaultTsv</span><span class="p">()</span></div>

<div class="viewcode-block" id="WithParser.defaultTsvWithHeader"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.defaultTsvWithHeader">[docs]</a>    <span class="k">def</span> <span class="nf">defaultTsvWithHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">defaultTsvWithHeader</span><span class="p">()</span></div>

<div class="viewcode-block" id="WithParser.csvAttr"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.WithParser.csvAttr">[docs]</a>    <span class="k">def</span> <span class="nf">csvAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specifies the csv file format.  Corresponds to the CsvAttributes case class in Scala.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>

<span class="c1"># Note: due to python MRO, WithParser MUST come first in inheritance hierarchy.</span>
<span class="c1"># Otherwise we will pick methods up from SmvDataSet instead of WithParser.</span>
<div class="viewcode-block" id="SmvCsvFile"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvCsvFile">[docs]</a><span class="k">class</span> <span class="nc">SmvCsvFile</span><span class="p">(</span><span class="n">WithParser</span><span class="p">,</span> <span class="n">SmvPyInput</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Input from a file in CSV format</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smvApp</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SmvCsvFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">smvApp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smvCsvFile</span> <span class="o">=</span> <span class="n">smvApp</span><span class="o">.</span><span class="n">j_smvPyClient</span><span class="o">.</span><span class="n">smvCsvFile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fqn</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">csvAttr</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceParserCheck</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">failAtParsingError</span><span class="p">())</span>

<div class="viewcode-block" id="SmvCsvFile.getRawScalaInputDS"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvCsvFile.getRawScalaInputDS">[docs]</a>    <span class="k">def</span> <span class="nf">getRawScalaInputDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smvCsvFile</span></div>

<div class="viewcode-block" id="SmvCsvFile.description"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvCsvFile.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Input file: @&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">()</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractproperty</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User-specified path to the input csv file</span>

<span class="sd">            Override this to specify the path to the csv file.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (str): path</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SmvCsvFile.doRun"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvCsvFile.doRun">[docs]</a>    <span class="k">def</span> <span class="nf">doRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="n">jdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smvCsvFile</span><span class="o">.</span><span class="n">doRun</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">jdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">sqlContext</span><span class="p">))</span></div></div>

<span class="c1"># Note: due to python MRO, WithParser MUST come first in inheritance hierarchy.</span>
<span class="c1"># Otherwise we will pick methods up from SmvDataSet instead of WithParser.</span>
<div class="viewcode-block" id="SmvMultiCsvFiles"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvMultiCsvFiles">[docs]</a><span class="k">class</span> <span class="nc">SmvMultiCsvFiles</span><span class="p">(</span><span class="n">WithParser</span><span class="p">,</span> <span class="n">SmvPyInput</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raw input from multiple csv files sharing single schema</span>

<span class="sd">        Instead of a single input file, specify a data dir with files which share</span>
<span class="sd">        the same schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smvApp</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SmvMultiCsvFiles</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">smvApp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smvMultiCsvFiles</span> <span class="o">=</span> <span class="n">smvApp</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">tresamigos</span><span class="o">.</span><span class="n">smv</span><span class="o">.</span><span class="n">SmvMultiCsvFiles</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csvAttr</span><span class="p">(),</span>
            <span class="kc">None</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SmvMultiCsvFiles.getRawScalaInputDS"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvMultiCsvFiles.getRawScalaInputDS">[docs]</a>    <span class="k">def</span> <span class="nf">getRawScalaInputDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smvMultiCsvFiles</span></div>

<div class="viewcode-block" id="SmvMultiCsvFiles.description"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvMultiCsvFiles.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Input dir: @&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractproperty</span>
    <span class="k">def</span> <span class="nf">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the directory containing the csv files and their schema</span>

<span class="sd">            Returns:</span>
<span class="sd">                (str): path</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SmvMultiCsvFiles.doRun"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvMultiCsvFiles.doRun">[docs]</a>    <span class="k">def</span> <span class="nf">doRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="n">jdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smvMultiCsvFiles</span><span class="o">.</span><span class="n">doRun</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">jdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">sqlContext</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="SmvCsvStringData"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvCsvStringData">[docs]</a><span class="k">class</span> <span class="nc">SmvCsvStringData</span><span class="p">(</span><span class="n">SmvPyInput</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Input data defined by a schema string and data string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smvApp</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SmvCsvStringData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">smvApp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smvCsvStringData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">tresamigos</span><span class="o">.</span><span class="n">smv</span><span class="o">.</span><span class="n">SmvCsvStringData</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schemaStr</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataStr</span><span class="p">(),</span>
            <span class="kc">False</span>
        <span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractproperty</span>
    <span class="k">def</span> <span class="nf">schemaStr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Smv Schema string.</span>

<span class="sd">            E.g. &quot;id:String; dt:Timestamp&quot;</span>

<span class="sd">            Returns:</span>
<span class="sd">                (str): schema</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractproperty</span>
    <span class="k">def</span> <span class="nf">dataStr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Smv data string.</span>

<span class="sd">            E.g. &quot;212,2016-10-03;119,2015-01-07&quot;</span>

<span class="sd">            Returns:</span>
<span class="sd">                (str): data</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SmvCsvStringData.doRun"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvCsvStringData.doRun">[docs]</a>    <span class="k">def</span> <span class="nf">doRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="n">jdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smvCsvStringData</span><span class="o">.</span><span class="n">doRun</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">jdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">sqlContext</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SmvHiveTable"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvHiveTable">[docs]</a><span class="k">class</span> <span class="nc">SmvHiveTable</span><span class="p">(</span><span class="n">SmvPyInput</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Input from a Hive table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smvApp</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SmvHiveTable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">smvApp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smvHiveTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">tresamigos</span><span class="o">.</span><span class="n">smv</span><span class="o">.</span><span class="n">SmvHiveTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableName</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableQuery</span><span class="p">())</span>

<div class="viewcode-block" id="SmvHiveTable.description"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvHiveTable.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Hive Table: @&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableName</span><span class="p">()</span></div>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractproperty</span>
    <span class="k">def</span> <span class="nf">tableName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User-specified name Hive hive table to extract input from</span>

<span class="sd">            Override this to specify your own table name.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (str): table name</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SmvHiveTable.tableQuery"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvHiveTable.tableQuery">[docs]</a>    <span class="k">def</span> <span class="nf">tableQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query used to extract data from Hive table</span>

<span class="sd">            Override this to specify your own query (optional). Default is</span>
<span class="sd">            equivalent to &#39;select * from &#39; + tableName().</span>

<span class="sd">            Returns:</span>
<span class="sd">                (str): query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SmvHiveTable.doRun"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvHiveTable.doRun">[docs]</a>    <span class="k">def</span> <span class="nf">doRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_smvHiveTable</span><span class="o">.</span><span class="n">rdd</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">sqlContext</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="SmvModule"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModule">[docs]</a><span class="k">class</span> <span class="nc">SmvModule</span><span class="p">(</span><span class="n">SmvPyDataSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for SmvModules written in Python</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">IsSmvModule</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="SmvModule.dsType"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModule.dsType">[docs]</a>    <span class="k">def</span> <span class="nf">dsType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Module&quot;</span></div>


<div class="viewcode-block" id="SmvModule.RunParams"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModule.RunParams">[docs]</a>    <span class="k">class</span> <span class="nc">RunParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map from SmvDataSet to resulting DataFrame</span>

<span class="sd">            We need to simulate a dict from ds to df where the same object can be</span>
<span class="sd">            keyed by different datasets with the same urn. For example, in the</span>
<span class="sd">            module</span>

<span class="sd">            class X(SmvModule):</span>
<span class="sd">                def requiresDS(self): return [SmvModuleLink(&quot;foo&quot;)]</span>
<span class="sd">                def run(self, i): return i[SmvModuleLink(&quot;foo&quot;)]</span>

<span class="sd">            the i argument of the run method should map SmvModuleLink(&quot;foo&quot;) to</span>
<span class="sd">            the correct DataFrame.</span>

<span class="sd">            Args:</span>
<span class="sd">                (dict): a map from urn to DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urn2df</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">urn2df</span> <span class="o">=</span> <span class="n">urn2df</span>

        <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Called by the &#39;[]&#39; operator</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">urn2df</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">urn</span><span class="p">()]</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smvApp</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SmvModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">smvApp</span><span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<div class="viewcode-block" id="SmvModule.run"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModule.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User-specified definition of the operations of this SmvModule</span>

<span class="sd">            Override this method to define the output of this module, given a map</span>
<span class="sd">            &#39;i&#39; from inputSmvDataSet to resulting DataFrame. &#39;i&#39; will have a</span>
<span class="sd">            mapping for each SmvDataSet listed in requiresDS. E.g.</span>

<span class="sd">            def requiresDS(self):</span>
<span class="sd">                return [MyDependency]</span>

<span class="sd">            def run(self, i):</span>
<span class="sd">                return i[MyDependency].select(&quot;importantColumn&quot;)</span>

<span class="sd">            Args:</span>
<span class="sd">                (RunParams): mapping from input SmvDataSet to DataFrame</span>

<span class="sd">            Returns:</span>
<span class="sd">                (DataFrame): ouput of this SmvModule</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="SmvModule.doRun"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModule.doRun">[docs]</a>    <span class="k">def</span> <span class="nf">doRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">):</span>
        <span class="n">urn2df</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requiresDS</span><span class="p">():</span>
            <span class="n">urn2df</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">urn</span><span class="p">()]</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">known</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">urn</span><span class="p">()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">smvApp</span><span class="o">.</span><span class="n">sqlContext</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RunParams</span><span class="p">(</span><span class="n">urn2df</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="SmvModuleLinkTemplate"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModuleLinkTemplate">[docs]</a><span class="k">class</span> <span class="nc">SmvModuleLinkTemplate</span><span class="p">(</span><span class="n">SmvModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A module link provides access to data generated by modules from another stage</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">IsSmvModuleLink</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SmvModuleLinkTemplate.urn"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModuleLinkTemplate.urn">[docs]</a>    <span class="k">def</span> <span class="nf">urn</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;link:&#39;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">target</span><span class="p">()</span><span class="o">.</span><span class="n">fqn</span><span class="p">()</span></div>

<div class="viewcode-block" id="SmvModuleLinkTemplate.isEphemeral"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModuleLinkTemplate.isEphemeral">[docs]</a>    <span class="k">def</span> <span class="nf">isEphemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SmvModuleLinkTemplate.dsType"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModuleLinkTemplate.dsType">[docs]</a>    <span class="k">def</span> <span class="nf">dsType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Link&quot;</span></div>

<div class="viewcode-block" id="SmvModuleLinkTemplate.requiresDS"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModuleLinkTemplate.requiresDS">[docs]</a>    <span class="k">def</span> <span class="nf">requiresDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SmvModuleLinkTemplate.target"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModuleLinkTemplate.target">[docs]</a>    <span class="k">def</span> <span class="nf">target</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the target SmvModule class from another stage to which this link points&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expect to be implemented by subclass&#39;</span><span class="p">)</span></div></div>

<span class="n">PyExtDataSetCache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="kn">from</span> <span class="nn">smvapp</span> <span class="k">import</span> <span class="n">SmvApp</span>

<div class="viewcode-block" id="SmvExtDataSet"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvExtDataSet">[docs]</a><span class="k">def</span> <span class="nf">SmvExtDataSet</span><span class="p">(</span><span class="n">refname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an SmvDataSet representing an external (Scala) SmvDataSet</span>

<span class="sd">        E.g. MyExtMod = SmvExtDataSet(&quot;the.scala.mod&quot;)</span>

<span class="sd">        Args:</span>
<span class="sd">            fqn (str): fqn of the Scala SmvDataSet</span>

<span class="sd">        Returns:</span>
<span class="sd">            (SmvExtDataSet): external dataset with given fqn</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">refname</span> <span class="ow">in</span> <span class="n">PyExtDataSetCache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PyExtDataSetCache</span><span class="p">[</span><span class="n">refname</span><span class="p">]</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;SmvExtDataSet&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SmvPyDataSet</span><span class="p">,),</span> <span class="p">{</span>
        <span class="s2">&quot;refname&quot;</span> <span class="p">:</span> <span class="n">refname</span><span class="p">,</span>
        <span class="s2">&quot;smvApp&quot;</span>   <span class="p">:</span> <span class="n">SmvApp</span><span class="o">.</span><span class="n">getInstance</span><span class="p">(),</span>
        <span class="s2">&quot;doRun&quot;</span>   <span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">known</span><span class="p">:</span> <span class="n">smvApp</span><span class="o">.</span><span class="n">runModule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urn</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">fqn</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="k">lambda</span> <span class="n">klass</span><span class="p">:</span> <span class="n">refname</span><span class="p">)</span>
    <span class="n">PyExtDataSetCache</span><span class="p">[</span><span class="n">refname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
    <span class="k">return</span> <span class="bp">cls</span></div>

<div class="viewcode-block" id="SmvModuleLink"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvModuleLink">[docs]</a><span class="k">def</span> <span class="nf">SmvModuleLink</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a link to an SmvDataSet</span>

<span class="sd">        When a module X in one stage depends on a module Y in a different stage,</span>
<span class="sd">        it must do through through an SmvModuleLink (listing Y directly as a</span>
<span class="sd">        dependency will lead to a runtime error). For example,::</span>

<span class="sd">            # In stage s1</span>
<span class="sd">            class Y(SmvModule):</span>
<span class="sd">                ...</span>

<span class="sd">            # In stage s2</span>
<span class="sd">            class X(SmvModule)</span>
<span class="sd">                def requiresDS(self): return [SmvModuleLink(Y)]</span>
<span class="sd">                ...</span>

<span class="sd">        Args:</span>
<span class="sd">            ds (SmvDataSet): dataset to link to</span>

<span class="sd">        Returns:</span>
<span class="sd">            (SmvModuleLink): link to ds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;SmvModuleLink&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SmvModuleLinkTemplate</span><span class="p">,),</span> <span class="p">{})</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="k">lambda</span> <span class="n">klass</span><span class="p">:</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span></div>

<div class="viewcode-block" id="SmvExtModuleLink"><a class="viewcode-back" href="../../smv.html#smv.smvpydataset.SmvExtModuleLink">[docs]</a><span class="k">def</span> <span class="nf">SmvExtModuleLink</span><span class="p">(</span><span class="n">refname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a link to an external (Scala) SmvDataSet</span>

<span class="sd">        SmvExtModuleLink(fqn) is equivalent to SmvModuleLink(SmvExtDataSet(fqn))</span>

<span class="sd">        Args:</span>
<span class="sd">            fqn (str): fqn of the the Scala SmvDataSet</span>

<span class="sd">        Returns:</span>
<span class="sd">            (SmvModuleLink): link to the Scala SmvDataSet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">SmvModuleLink</span><span class="p">(</span><span class="n">SmvExtDataSet</span><span class="p">(</span><span class="n">refname</span><span class="p">))</span></div>

<span class="c1"># Aliases backwards compatibility</span>
<span class="n">SmvPyOutput</span> <span class="o">=</span> <span class="n">SmvOutput</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvOutput</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyExtDataSet</span> <span class="o">=</span> <span class="n">SmvExtDataSet</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvExtDataSet</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyCsvFile</span> <span class="o">=</span> <span class="n">SmvCsvFile</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvCsvFile</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyCsvStringData</span> <span class="o">=</span> <span class="n">SmvCsvStringData</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvCsvStringData</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyMultiCsvFiles</span> <span class="o">=</span> <span class="n">SmvMultiCsvFiles</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvMultiCsvFiles</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyHiveTable</span> <span class="o">=</span> <span class="n">SmvHiveTable</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvHiveTable</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyModule</span> <span class="o">=</span> <span class="n">SmvModule</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvModule</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyModuleLink</span> <span class="o">=</span> <span class="n">SmvModuleLink</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvModuleLink</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">SmvPyExtModuleLink</span> <span class="o">=</span> <span class="n">SmvExtModuleLink</span>
<span class="sd">&quot;&quot;&quot;Deprecated alias of SmvExtModuleLink</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>